#/bin/bash

if [ "$#" -ne 4 ]
then
    echo "Usage: ./$0 path_benchmark.mat stonne_inner_conf_file stonne_outer_conf_file stonne_gustavsons_conf_file"
    exit 1
fi

if test ! -f "$1" 
then
    echo "File $1 does not exist"
    exit 2
fi

if test ! -f "$2"
then
    echo "File $2 does not exist"
    exit 2
fi

if test ! -f "$3"
then
    echo "File $3 does not exist"
    exit 2
fi

if test ! -f "$4"
then
    echo "File $4 does not exist"
    exit 2
fi


PATH_BENCHMARK=$1
STONNE_INNER_CONF_FILE=$2
STONNE_OUTER_CONF_FILE=$3
STONNE_GUSTAVSONS_CONF_FILE=$4

name_benchmark=$(echo $PATH_BENCHMARK | sed -r "s/.+\/(.+)\..+/\1/")
DEST_DIR="bench_$name_benchmark"  # Destination where the files will be

if test -d "$DEST_DIR"
then
    echo "Deleting $DEST_DIR as the directory already exists"
    rm -rf $DEST_DIR
fi

mkdir $DEST_DIR 


#echo "Generating temporal files"
cp template_sst_stonne_outerProduct.py $DEST_DIR/temporal_sst_stonne_outerProduct.py
cp template_sst_stonne_bitmapSpMSpM.py $DEST_DIR/temporal_sst_stonne_bitmapSpMSpM.py
cp template_sst_stonne_gustavsons.py $DEST_DIR/temporal_sst_stonne_gustavsons.py

cp $STONNE_INNER_CONF_FILE $DEST_DIR/
cp $STONNE_OUTER_CONF_FILE $DEST_DIR/
cp $STONNE_GUSTAVSONS_CONF_FILE $DEST_DIR/

# Generating the file and parameters from the .mat file 
output_cmd=$(python format_benchmark.py $PATH_BENCHMARK)
mv *.in $DEST_DIR   # Moving the memory files generated by the script
mv *.ini $DEST_DIR  # Moving the memory files generated by the script

M=$(echo "$output_cmd" | grep "PARAMETER M:" | cut -f2 -d:)
echo "M=$M"
N=$(echo "$output_cmd" | grep "PARAMETER N:" | cut -f2 -d:)
K=$(echo "$output_cmd" | grep "PARAMETER K:" | cut -f2 -d:)
address_a=$(echo "$output_cmd" | grep "PARAMETER MEMORY_ADDRESS_A:" | cut -f2 -d:)
address_b=$(echo "$output_cmd" | grep "PARAMETER MEMORY_ADDRESS_B:" | cut -f2 -d:)
address_c=$(echo "$output_cmd" | grep "PARAMETER MEMORY_ADDRESS_C:" | cut -f2 -d:)




sed -i "s/GEMM_M_PARAMETER/$M/g" $DEST_DIR/temporal_*
sed -i "s/GEMM_N_PARAMETER/$N/g" $DEST_DIR/temporal_*
sed -i "s/GEMM_K_PARAMETER/$K/g" $DEST_DIR/temporal_*
sed -i "s/STONNE_INNER_PRODUCT_FILE/$STONNE_INNER_CONF_FILE/g" $DEST_DIR/temporal_*
sed -i "s/STONNE_OUTER_PRODUCT_FILE/$STONNE_OUTER_CONF_FILE/g" $DEST_DIR/temporal_*
sed -i "s/STONNE_GUSTAVSONS_FILE/$STONNE_GUSTAVSONS_CONF_FILE/g" $DEST_DIR/temporal_*

#  Replacing address in sst conf file 
sed -i "s/MATRIX_B_DRAM_ADDRESS_PARAMETER/$address_b/g" $DEST_DIR/temporal_*
sed -i "s/MATRIX_C_DRAM_ADDRESS_PARAMETER/$address_c/g" $DEST_DIR/temporal_*





